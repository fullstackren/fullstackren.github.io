<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSocket | 全栈孤勇者</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?f17885b1de21e5764929b001ee4d850b";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
    <meta name="description" content="全栈孤勇者">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <meta name="baidu-site-verification" content="code-XDF2R0xFu0">
    <meta name="google-site-verification" content="">
    
    <link rel="preload" href="/assets/css/0.styles.934cf12e.css" as="style"><link rel="preload" href="/assets/js/app.0e36f225.js" as="script"><link rel="preload" href="/assets/js/2.a3f250b7.js" as="script"><link rel="preload" href="/assets/js/1.359e53cd.js" as="script"><link rel="preload" href="/assets/js/92.3a862bd3.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.934cf12e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="全栈孤勇者" class="logo"> <span class="site-name can-hide">全栈孤勇者</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <!----></nav></div></header> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <!----></nav> <div style="padding-left:1.5rem;"><div class="qr"><img src="/assets/img/fullstack-ren-wechat.b86bdc8d.png" alt="全栈孤勇者" width="70" height="70" loading="lazy"> <p class="we-intro">
    订阅号：全栈孤勇者。<br>若加我微信（fullstack-ren）请备注<span class="highlight">全栈孤勇者</span>，然后加群「侃」大山。
  </p></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/html/html5.html" class="sidebar-link">HTML5</a></li><li><a href="/frontend/html/websocket.html" aria-current="page" class="active sidebar-link">WebSocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#websocket-优点" class="sidebar-link">WebSocket 优点</a></li><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#其他可实现实时通讯的方式" class="sidebar-link">其他可实现实时通讯的方式</a></li><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#websocket-指引" class="sidebar-link">WebSocket 指引</a></li><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#websocket-实例" class="sidebar-link">WebSocket 实例</a></li><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#websockert-心跳机制" class="sidebar-link">WebSockert 心跳机制</a></li><li class="sidebar-sub-header"><a href="/frontend/html/websocket.html#常见问题" class="sidebar-link">常见问题</a></li></ul></li></ul></section></li></ul> </aside> <!----> <!----> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"><div class="bar-container"><div class="bar-intro"><div class="text">每天成长一点</div></div></div></div> <div class="theme-default-content"><div class="content__default"><h1 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h1> <p>WebSocket 是 <a href="/frontend/html/html5.html">HTML5</a> 提供的一种在单个 <code>TCP</code> 连接上进行双向通信的协议，以解决客户端与服务端间 <code>实时通信问题</code>。此时，客户端浏览器和服务器只需完成一次握手就可以创建持久性的 TCP 连接，接着服务器就可以和浏览器进行 <code>双向实时通信</code>。</p> <h2 id="websocket-优点"><a href="#websocket-优点" class="header-anchor">#</a> WebSocket 优点</h2> <p>WebSocket 建立 TCP 连接后，服务器 <code>可主动</code> 向浏览器传递消息，能够更好的节省服务器资源和带宽，实现 <code>实时</code> 数据通讯。</p> <h2 id="其他可实现实时通讯的方式"><a href="#其他可实现实时通讯的方式" class="header-anchor">#</a> 其他可实现实时通讯的方式</h2> <p>可以使用 ajax 轮询。轮询是由浏览器在 <code>特定时间间隔</code> 主动向服务器发起请求，将服务器的数据拉回来。这样不断地向服务器发送请求，会 <code>占用很多带宽</code> 和 <code>服务器资源</code>。</p> <h2 id="websocket-指引"><a href="#websocket-指引" class="header-anchor">#</a> WebSocket 指引</h2> <ul><li>事件
<ul><li><code>ws.onmessage</code>：接收到消息的回调方法；</li> <li><code>ws.onopen</code>：连接成功建立的回调方法；</li> <li><code>ws.onclose</code>：连接关闭的回调方法；</li> <li><code>ws.onerror</code>：连接发生错误的回调方法；</li></ul></li> <li>方法
<ul><li><code>ws.send()</code>：发送消息；</li> <li><code>ws.close()</code>：关闭连接；</li></ul></li> <li>状态码
<ul><li><code>0</code>：表示连接尚未建立；</li> <li><code>1</code>：表示连接已建立，可以进行通信；</li> <li><code>2</code>：表示连接正在进行关闭；</li></ul></li></ul> <h2 id="websocket-实例"><a href="#websocket-实例" class="header-anchor">#</a> WebSocket 实例</h2> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">websocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;WebSocket&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;您访问的浏览器支持 WebSocket!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建 WebSocket 对象</span>
        <span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:2024/ws&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接成功建立的回调方法</span>
        ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送消息</span>
            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello WebSocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 接收到消息的回调方法</span>
        ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 接收到的消息</span>
            <span class="token keyword">let</span> msg <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接关闭的回调方法</span>
        ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 关闭 websocket</span>
            ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 连接发生错误的回调方法</span>
        ws<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 关闭 websocket</span>
            ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;您访问的浏览器不支持 WebSocket!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">websocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="websockert-心跳机制"><a href="#websockert-心跳机制" class="header-anchor">#</a> WebSockert 心跳机制</h2> <p>心跳检测，就是隔一段时间向服务器仅限一次数据访问，因为长时间不使用会导致ws自动断开，一般是 <code>间隔 90 秒</code> 内无操作会自动断开，因此，在间隔时间内进行一次数据访问，以防止 ws 断开即可。这是客户端和服务端之间的一种 <code>保活机制</code>。</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token comment">// 倒计时 30 秒内无操作则进行一次访问，有操作则重置计时器</span>
<span class="token comment">// 封装为键值对的形式，成为 JavaScript 对象，与 json 很相似</span>
<span class="token keyword">let</span> heartCheck <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// 30秒</span>
    <span class="token literal-property property">timeoutObj</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">reset</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 接收成功一次推送，就将心跳检测的倒计时重置为30秒</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重置倒计时</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 启动心跳检测机制，设置倒计时30秒一次</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeoutObj <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;t10010&quot;</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;发送维持连接消息！&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;发送维持连接消息！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动心跳</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// onopen 连接上，就开始 start 计时，如果在定时时间范围内，onmessage获取到了服务端消息，</span>
    <span class="token comment">// 就重置 reset 倒计时，距离上次从后端获取消息30秒后，执行心跳检测，看是不是断了。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// WebSocket</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//当WebSocket创建成功时，触发onopen事件</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将消息发送到服务端</span>
    heartCheck<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 连接成功之后启动心跳检测机制</span>
<span class="token punctuation">}</span>

ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当客户端收到服务端发来的消息时，触发 onmessage 事件，参数 e.data 包含server传递过来的数据</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 接收一次后台推送的消息，即进行一次心跳检测重置</span>
    heartCheck<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <p>服务器通过 WebSocket 推送频率太快，接收渲染跟不上，渲染会消耗内存，容易导致浏览器崩溃。这时，可与服务器协商 <code>放缓推送频率</code> 或 <code>摒弃掉短频快</code> 的数据（如 5 秒处理一次接受的数据）。</p> <p>如果推送数据流太大，可尝试将 <code>数据分页渲染</code> 或 <code>瀑布流渲染</code>，可减轻一定压力。</p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend/html/html5.html" class="prev">HTML5</a></span> <!----></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0e36f225.js" defer></script><script src="/assets/js/2.a3f250b7.js" defer></script><script src="/assets/js/1.359e53cd.js" defer></script><script src="/assets/js/92.3a862bd3.js" defer></script>
  </body>
</html>
